/*! For license information please see background.js.LICENSE.txt */
(()=>{function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=r(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var o=0,a=function(){};return{s:a,n:function(){return o>=t.length?{done:!0}:{done:!1,value:t[o++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,c=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return s=t.done,t},e:function(t){c=!0,i=t},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw i}}}}function r(t,e){if(t){if("string"==typeof t)return n(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function o(){"use strict";o=function(){return r};var e,r={},n=Object.prototype,a=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",c=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag";function l(t,e,r,n){return Object.defineProperty(t,e,{value:r,enumerable:!n,configurable:!n,writable:!n})}try{l({},"")}catch(e){l=function(t,e,r){return t[e]=r}}function p(t,r,n,o){var a=r&&r.prototype instanceof g?r:g,i=Object.create(a.prototype);return l(i,"_invoke",function(t,r,n){var o=1;return function(a,i){if(3===o)throw Error("Generator is already running");if(4===o){if("throw"===a)throw i;return{value:e,done:!0}}for(n.method=a,n.arg=i;;){var s=n.delegate;if(s){var c=k(s,n);if(c){if(c===f)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(1===o)throw o=4,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=3;var u=h(t,r,n);if("normal"===u.type){if(o=n.done?4:2,u.arg===f)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=4,n.method="throw",n.arg=u.arg)}}}(t,n,new S(o||[])),!0),i}function h(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}r.wrap=p;var f={};function g(){}function y(){}function m(){}var d={};l(d,s,(function(){return this}));var v=Object.getPrototypeOf,b=v&&v(v(O([])));b&&b!==n&&a.call(b,s)&&(d=b);var w=m.prototype=g.prototype=Object.create(d);function _(t){["next","throw","return"].forEach((function(e){l(t,e,(function(t){return this._invoke(e,t)}))}))}function x(e,r){function n(o,i,s,c){var u=h(e[o],e,i);if("throw"!==u.type){var l=u.arg,p=l.value;return p&&"object"==t(p)&&a.call(p,"__await")?r.resolve(p.__await).then((function(t){n("next",t,s,c)}),(function(t){n("throw",t,s,c)})):r.resolve(p).then((function(t){l.value=t,s(l)}),(function(t){return n("throw",t,s,c)}))}c(u.arg)}var o;l(this,"_invoke",(function(t,e){function a(){return new r((function(r,o){n(t,e,r,o)}))}return o=o?o.then(a,a):a()}),!0)}function k(t,r){var n=r.method,o=t.i[n];if(o===e)return r.delegate=null,"throw"===n&&t.i.return&&(r.method="return",r.arg=e,k(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),f;var a=h(o,t.i,r.arg);if("throw"===a.type)return r.method="throw",r.arg=a.arg,r.delegate=null,f;var i=a.arg;return i?i.done?(r[t.r]=i.value,r.next=t.n,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,f):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,f)}function A(t){this.tryEntries.push(t)}function z(t){var r=t[4]||{};r.type="normal",r.arg=e,t[4]=r}function S(t){this.tryEntries=[[-1]],t.forEach(A,this),this.reset(!0)}function O(r){if(null!=r){var n=r[s];if(n)return n.call(r);if("function"==typeof r.next)return r;if(!isNaN(r.length)){var o=-1,i=function t(){for(;++o<r.length;)if(a.call(r,o))return t.value=r[o],t.done=!1,t;return t.value=e,t.done=!0,t};return i.next=i}}throw new TypeError(t(r)+" is not iterable")}return y.prototype=m,l(w,"constructor",m),l(m,"constructor",y),y.displayName=l(m,u,"GeneratorFunction"),r.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},r.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,l(t,u,"GeneratorFunction")),t.prototype=Object.create(w),t},r.awrap=function(t){return{__await:t}},_(x.prototype),l(x.prototype,c,(function(){return this})),r.AsyncIterator=x,r.async=function(t,e,n,o,a){void 0===a&&(a=Promise);var i=new x(p(t,e,n,o),a);return r.isGeneratorFunction(e)?i:i.next().then((function(t){return t.done?t.value:i.next()}))},_(w),l(w,u,"Generator"),l(w,s,(function(){return this})),l(w,"toString",(function(){return"[object Generator]"})),r.keys=function(t){var e=Object(t),r=[];for(var n in e)r.unshift(n);return function t(){for(;r.length;)if((n=r.pop())in e)return t.value=n,t.done=!1,t;return t.done=!0,t}},r.values=O,S.prototype={constructor:S,reset:function(t){if(this.prev=this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(z),!t)for(var r in this)"t"===r.charAt(0)&&a.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0][4];if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function n(e){i.type="throw",i.arg=t,r.next=e}for(var o=r.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],i=a[4],s=this.prev,c=a[1],u=a[2];if(-1===a[0])return n("end"),!1;if(!c&&!u)throw Error("try statement without catch or finally");if(null!=a[0]&&a[0]<=s){if(s<c)return this.method="next",this.arg=e,n(c),!0;if(s<u)return n(u),!1}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n[0]>-1&&n[0]<=this.prev&&this.prev<n[2]){var o=n;break}}o&&("break"===t||"continue"===t)&&o[0]<=e&&e<=o[2]&&(o=null);var a=o?o[4]:{};return a.type=t,a.arg=e,o?(this.method="next",this.next=o[2],f):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),f},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[2]===t)return this.complete(r[4],r[3]),z(r),f}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r[0]===t){var n=r[4];if("throw"===n.type){var o=n.arg;z(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={i:O(t),r,n},"next"===this.method&&(this.arg=e),f}},r}function a(t,e,r,n,o,a,i){try{var s=t[a](i),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function i(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function s(t){a(i,n,o,s,c,"next",t)}function c(t){a(i,n,o,s,c,"throw",t)}s(void 0)}))}}function s(t){return t?t.replace(/\b(Inc|Ltd|Corp|Corporation|LLC|Limited|Company|Co|Entertainment|Interactive)\.?\b/gi,"").trim():""}function c(t,e){var r=t.toLowerCase(),n=e.toLowerCase();if(r===n)return 100;var o=0;(r.includes(n)||n.includes(r))&&(o+=50);var a=r.split(/\s+/).filter((function(t){return t.length>1})),i=n.split(/\s+/).filter((function(t){return t.length>1}));return o+=10*a.filter((function(t){return i.includes(t)})).length,o-=.5*Math.abs(r.length-n.length),Math.max(0,o)}function u(t){var e=s(t).toLowerCase().replace(/\s+/g,"");return(e=e.replace(/[^a-z0-9.]/g,"")).includes(".")||(e+=".com"),e}var l="RkAYDXn_fooT15v42PkAwg";function p(t){return h.apply(this,arguments)}function h(){return(h=i(o().mark((function t(e){var r,n,a,i,s;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e){t.next=2;break}return t.abrupt("return",null);case 2:return r="https://api.apollo.io/api/v1/organizations/enrich?domain=".concat(e),t.prev=3,console.log("Apollo API: Enriching organization by domain:",e),t.next=7,fetch(r,{method:"GET",headers:{"Cache-Control":"no-cache","Content-Type":"application/json","X-Api-Key":l}});case 7:return n=t.sent,t.next=10,n.json();case 10:if(a=t.sent,console.log("Apollo API: Org enrichment response:",JSON.stringify(a,null,2)),n.ok&&a.organization){t.next=14;break}throw new Error("HTTP error! status: ".concat(n.status," - ").concat(JSON.stringify(a)));case 14:if((i=a.organization)&&!i.domain&&i.website_url)try{s=new URL(i.website_url),i.domain=s.hostname,i.domain.startsWith("www.")&&(i.domain=i.domain.substring(4))}catch(t){console.warn("Could not parse domain from website_url for enriched org:",i.name,"URL:",i.website_url,t)}return t.abrupt("return",i);case 19:return t.prev=19,t.t0=t.catch(3),console.error("Error enriching organization by domain:",t.t0),t.abrupt("return",null);case 23:case"end":return t.stop()}}),t,null,[[3,19]])})))).apply(this,arguments)}function f(t){return g.apply(this,arguments)}function g(){return g=i(o().mark((function t(e){var r,n,a,i,s,c=arguments;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=c.length>2&&void 0!==c[2]?c[2]:[],a={q_organization_name:e,page:1,per_page:50},(r=c.length>1&&void 0!==c[1]?c[1]:[]).length>0&&(a.organization_locations=r),n.length>0&&(a.q_organization_keyword_tags=n),t.prev=6,console.log("Apollo API: Searching for organization:",e,"Locations:",r,"Keywords:",n),t.next=10,fetch("https://api.apollo.io/api/v1/mixed_companies/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache","X-Api-Key":l},body:JSON.stringify(a)});case 10:return i=t.sent,t.next=13,i.json();case 13:if(s=t.sent,console.log("Apollo API: Full org search response:",JSON.stringify(s,null,2)),i.ok){t.next=17;break}throw new Error("HTTP error! status: ".concat(i.status," - ").concat(JSON.stringify(s)));case 17:return t.abrupt("return",s.organizations||s.accounts||s.companies||[]);case 20:return t.prev=20,t.t0=t.catch(6),console.error("Error searching organization on Apollo:",t.t0),t.abrupt("return",[]);case 24:case"end":return t.stop()}}),t,null,[[6,20]])}))),g.apply(this,arguments)}function y(t){return m.apply(this,arguments)}function m(){return m=i(o().mark((function t(a){var i,l,p,h,g,y,m,d,v,b,w,_,x,k,A,z,S,O,C,E,L,j,T,q,I=arguments;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=I.length>1&&void 0!==I[1]?I[1]:[],l=I.length>2&&void 0!==I[2]?I[2]:[],(p=new Set).add(a),p.add(s(a)),(h=a.split(" ")).length>0&&p.add(h[0]),h.length>2&&(g=h.slice(0,h.length-1).join(" ").replace(/(Inc|Ltd|Corp|Corporation|LLC|Limited|Company|Co|Entertainment|Interactive|Canada)\.?/gi,"").trim())&&g!==a&&p.add(g),(y=a.replace(/\sCanada\s*(Inc|Ltd|Corp|Corporation|LLC|Limited|Company|Co|Entertainment|Interactive)?\b/gi,"").trim())&&y!==a&&p.add(y),m=[],d=0,v=Array.from(p);case 12:if(!(d<v.length)){t.next=24;break}if(b=v[d]){t.next=16;break}return t.abrupt("continue",21);case 16:return console.log('Apollo API: Trying organization name query: "'.concat(b,'"')),t.next=19,f(b,i,l);case 19:(w=t.sent)&&w.length>0&&m.push.apply(m,function(t){if(Array.isArray(t))return n(t)}(o=w)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(o)||r(o)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());case 21:d++,t.next=12;break;case 24:if(_=null,x=-1,k=a.toLowerCase(),!(A=u(a))){t.next=47;break}z=e(m),t.prev=30,z.s();case 32:if((S=z.n()).done){t.next=39;break}if(!(O=S.value).primary_domain||O.primary_domain.toLowerCase()!==A){t.next=37;break}return console.log('Found exact domain match for "'.concat(a,'": "').concat(O.name,'" -> "').concat(O.primary_domain,'"')),t.abrupt("return",O);case 37:t.next=32;break;case 39:t.next=44;break;case 41:t.prev=41,t.t0=t.catch(30),z.e(t.t0);case 44:return t.prev=44,z.f(),t.finish(44);case 47:C=0,E=m;case 48:if(!(C<E.length)){t.next=59;break}if((L=E[C]).name){t.next=52;break}return t.abrupt("continue",56);case 52:j=L.name.toLowerCase(),T=c(k,j),L.website_url&&L.primary_domain&&(T+=20),T>x&&(x=T,_=L);case 56:C++,t.next=48;break;case 59:if(_){if(_.website_url)try{q=new URL(_.website_url),_.domain=q.hostname,_.domain.startsWith("www.")&&(_.domain=_.domain.substring(4)),console.log("Extracted domain from website_url for selected best match org:",_.name,"->",_.domain)}catch(t){console.warn("Could not parse domain from website_url for org:",_.name,"URL:",_.website_url,t)}console.log('Found best match for "'.concat(a,'": "').concat(_.name,'" with score ').concat(x))}else console.warn('No strong match found for "'.concat(a,'" among Apollo results.'));return t.abrupt("return",_);case 61:case"end":return t.stop()}var o}),t,null,[[30,41,44,47]])}))),m.apply(this,arguments)}function d(t){return v.apply(this,arguments)}function v(){return(v=i(o().mark((function t(e){var r,n,a;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r={},e.organization&&(e.organization.domain&&(r.q_organization_domains_list=[e.organization.domain]),e.organization.id&&(r.organization_ids=[e.organization.id]),e.organization.name&&(r.q_organization_names=[e.organization.name])),e.personTitles&&e.personTitles.length>0&&(r.person_titles=e.personTitles,r.include_similar_titles=!0),e.personSeniorities&&e.personSeniorities.length>0&&(r.person_seniorities=e.personSeniorities),e.organizationLocations&&e.organizationLocations.length>0&&(r.organization_locations=e.organizationLocations),e.personLocations&&e.personLocations.length>0&&(r.person_locations=e.personLocations),e.q_keywords&&(r.q_keywords=e.q_keywords),e.contact_email_status&&e.contact_email_status.length>0&&(r.contact_email_status=e.contact_email_status),e.organization_num_employees_ranges&&e.organization_num_employees_ranges.length>0&&(r.organization_num_employees_ranges=e.organization_num_employees_ranges),r.page=e.page||1,r.per_page=e.per_page||25,t.prev=12,console.log("Apollo API: Calling mixed_people/search with body:",r),t.next=16,fetch("https://api.apollo.io/api/v1/mixed_people/search",{method:"POST",headers:{"Content-Type":"application/json","Cache-Control":"no-cache","X-Api-Key":l},body:JSON.stringify(r)});case 16:return n=t.sent,t.next=19,n.json();case 19:if(a=t.sent,console.log("Apollo API: mixed_people/search response:",JSON.stringify(a,null,2)),n.ok){t.next=23;break}throw new Error("HTTP error! status: ".concat(n.status," - ").concat(JSON.stringify(a)));case 23:return t.abrupt("return",a.people||[]);case 26:return t.prev=26,t.t0=t.catch(12),console.error("Error searching people on Apollo:",t.t0),t.abrupt("return",[]);case 30:case"end":return t.stop()}}),t,null,[[12,26]])})))).apply(this,arguments)}function b(){return(b=i(o().mark((function t(e){var r,n,a,i,s,c,u,l,p,h,f,g,y;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e["Job Title"]||"",n=e.Organization||"",a=e["Job Description"]||"",i=e.Requirements||"",s="Given the following job posting, generate a JSON object with:\n- job_titles: 5-7 specific job titles of people who would be decision makers or involved in hiring for this role (e.g., managers, team leads, recruiters, department heads)\n- seniorities: relevant seniority levels (e.g., entry, manager, director, vp, c_suite)\n- keywords: relevant keywords or skills for the search\n\nJob Title: ".concat(r,"\nCompany: ").concat(n,"\nDescription: ").concat(a.substring(0,400),"\nRequirements: ").concat(i.substring(0,200),'\n\nReturn ONLY a JSON object like:\n{\n  "job_titles": [...],\n  "seniorities": [...],\n  "keywords": [...]\n}'),t.prev=5,t.next=8,fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat("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")},body:JSON.stringify({model:"gpt-4o-mini",messages:[{role:"system",content:"You are an expert at extracting structured search parameters from job postings. Always respond with valid JSON."},{role:"user",content:s}],max_tokens:300,temperature:.2})});case 8:if((c=t.sent).ok){t.next=14;break}return t.next=12,c.json();case 12:throw l=t.sent,new Error("OpenAI API error: ".concat((null===(u=l.error)||void 0===u?void 0:u.message)||c.statusText));case 14:return t.next=16,c.json();case 16:if(p=t.sent,h=p.choices[0].message.content.trim(),f=h.indexOf("{"),g=h.lastIndexOf("}")+1,-1!==f&&-1!==g){t.next=22;break}throw new Error("No JSON found in LLM response");case 22:return y=JSON.parse(h.substring(f,g)),t.abrupt("return",y);case 26:throw t.prev=26,t.t0=t.catch(5),console.error("Error calling OpenAI for LLM params:",t.t0),t.t0;case 30:case"end":return t.stop()}}),t,null,[[5,26]])})))).apply(this,arguments)}chrome.runtime.onMessage.addListener((function(t,e,r){return"findRelevantConnections"===t.action?(i(o().mark((function e(){var n,a,i,s,c;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(n=t.query.organization_name)&&"string"==typeof n&&n.trim()){e.next=6;break}return console.error("Organization name is missing or invalid:",n),r({error:"Organization name is missing or invalid."}),e.abrupt("return");case 6:return console.log("Trying org names:",n),e.next=9,p(u(n));case 9:if(a=e.sent){e.next=15;break}return console.log("Falling back to name-based organization search."),e.next=14,y(n,Array.isArray(t.query.organization_locations)?t.query.organization_locations:[],Array.isArray(t.query.q_organization_keyword_tags)?t.query.q_organization_keyword_tags:[]);case 14:a=e.sent;case 15:if(console.log("Organization result:",a),a){e.next=19;break}return r({error:"Organization not found. Please try editing the organization name and scan again."}),e.abrupt("return");case 19:return i=t.query.title,e.prev=20,console.log("Requesting AI-generated titles..."),e.next=24,generateContactTitlesWithOpenAI(t.query);case 24:(null==(s=e.sent)?void 0:s.length)>0&&(i=s,console.log("Successfully using AI-generated titles:",i)),e.next=31;break;case 28:e.prev=28,e.t0=e.catch(20),console.warn("LLM title generation failed. Falling back to keyword-based titles.",e.t0);case 31:return e.next=33,d({organization:a,personSeniorities:Array.isArray(t.query.person_seniorities)?t.query.person_seniorities:[],personTitles:Array.isArray(i)?i:[],organizationLocations:Array.isArray(t.query.organization_locations)?t.query.organization_locations:[],q_keywords:t.query.q_keywords||"",contact_email_status:Array.isArray(t.query.contact_email_status)?t.query.contact_email_status:[],organization_num_employees_ranges:Array.isArray(t.query.organization_num_employees_ranges)?t.query.organization_num_employees_ranges:[]});case 33:c=e.sent,console.log("People result:",c),r({organization:a,people:c}),e.next=42;break;case 38:e.prev=38,e.t1=e.catch(0),console.error("Error in background script:",e.t1),r({error:e.t1.message});case 42:case"end":return e.stop()}}),e,null,[[0,38],[20,28]])})))(),!0):"generateLLMParams"===t.action?(function(t){return b.apply(this,arguments)}(t.jobData).then((function(t){return r({success:!0,params:t})})).catch((function(t){return r({success:!1,error:t.message})})),!0):void 0}))})();